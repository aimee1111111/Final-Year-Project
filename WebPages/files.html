<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>File Upload & Scan</title>
  <link rel="stylesheet" href="files.css">
</head>
<body>
  <h1>Upload File for Virus Scan</h1>

  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" id="fileInput" hidden />

    <div id="dropzone"
         class="dropzone"
         role="button"
         tabindex="0"
         aria-label="File upload dropzone. Press Enter to choose a file or drop a file here.">
      <div>ðŸ“„ Drop your file here</div>
      <div class="hint">or click to choose a file</div>
      <div id="fileName" aria-live="polite"></div>
    </div>

    <button type="submit">Upload &amp; Scan</button>
  </form>

  <div id="result" aria-live="polite"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const resultDiv = document.getElementById('result');
    const fileNameEl = document.getElementById('fileName');

    // Helpers
    function setFile(file) {
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      fileNameEl.textContent = `Selected: ${file.name}`;
    }

    function renderResult(result) {
      // Primary line (clean vs threats)
      let header;
      if (result.safe) {
        header = `âœ“ ${result.message || 'File is clean'}`;
      } else {
        const items = (result.threats && result.threats.length)
          ? result.threats.join(', ')
          : 'Unknown';
        header = `âœ— ${result.message || 'Threats detected'} â€” ${items}`;
      }

      // Per-engine breakdown from scan_results (ClamAV + YARA)
      let breakdown = '';
      if (Array.isArray(result.scan_results)) {
        const parts = result.scan_results.map(r => {
          const eng = r.engine || 'Engine';
          const status = r.status || 'unknown';

          // details can be a string or array (YARA threats array)
          let detail = '';
          if (r.details) {
            if (typeof r.details === 'string') {
              detail = ` â€” ${r.details}`;
            } else if (Array.isArray(r.details)) {
              // YARA details array of matches: show rule names
              const rules = r.details.map(d => d.rule || JSON.stringify(d)).join('; ');
              detail = rules ? ` â€” ${rules}` : '';
            } else if (typeof r.details === 'object') {
              detail = ` â€” ${JSON.stringify(r.details)}`;
            }
          }
          if (r.error) {
            detail = ` â€” error: ${r.error}`;
          }
          return `${eng}: ${status}${detail}`;
        });
        breakdown = parts.join(' | ');
      }

      // Fallback to engines dict if present
      if (!breakdown && result.engines) {
        const parts = [];
        for (const [name, obj] of Object.entries(result.engines)) {
          if (!obj) continue;
          const status = obj.safe === true ? 'clean'
                        : obj.safe === false ? 'threat_detected'
                        : 'error';
          const detail = obj.threat || obj.error || '';
          parts.push(`${name}: ${status}${detail ? ' â€” ' + detail : ''}`);
        }
        breakdown = parts.join(' | ');
      }

      resultDiv.textContent = breakdown ? `${header} (${breakdown})` : header;
    }

    async function uploadCurrentFile() {
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a file');
        return;
      }
      const formData = new FormData();
      formData.append('file', file);
      resultDiv.textContent = 'Scanning file...';

      try {
        const response = await fetch('http://localhost:5000/upload', {
          method: 'POST',
          body: formData
        });

        const ct = response.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await response.text();
          throw new Error('Server returned non-JSON: ' + text.slice(0, 200));
        }

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.message || `Server error (${response.status})`);
        }

        renderResult(result);
      } catch (err) {
        resultDiv.textContent = `Upload failed: ${err.message}`;
      }
    }

    // Click to open file picker
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // Show chosen file name when using picker
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      fileNameEl.textContent = f ? `Selected: ${f.name}` : '';
    });

    // Drag & drop events
    ['dragenter','dragover'].forEach(evtName => {
      dropzone.addEventListener(evtName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave','drop'].forEach(evtName => {
      dropzone.addEventListener(evtName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (!files || !files.length) return;

      setFile(files[0]);
    });

    // Submit handler (works for both picker and drop)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await uploadCurrentFile();
    });
  </script>

</body>
</html>
