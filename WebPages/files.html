<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>File Upload & Scan</title>
  <link rel="stylesheet" href="files.css">
</head>

<nav class="navbar">
    <div class="nav-left">
      <h2 class="logo">ThreatCheck</h2>
    </div>
    <div class="nav-right">
      <a href="Home.html">Home</a>
      <a href="Information.html">Information</a>
      <a href="ScanHistory.html">Scan History</a>
      <a href="logout.html" class="logout-btn">Log Out</a>
    </div>
  </nav>
<body>
  <h1>Upload File for Virus Scan</h1>

  <form id="uploadForm" enctype="multipart/form-data" class="panel">
    <input type="file" name="file" id="fileInput" hidden />

    <div id="dropzone"
         class="dropzone"
         role="button"
         tabindex="0"
         aria-label="File upload dropzone. Press Enter to choose a file or drop a file here.">
      <div>ðŸ“„ Drop your file here</div>
      <div class="hint">or click to choose a file</div>
      <div id="fileName" aria-live="polite"></div>
    </div>

    <div class="row">
      <button type="submit" class="btn btn-primary">Upload &amp; Scan</button>
      <button type="button" id="clearBtn" class="btn btn-ghost">Clear</button>
    </div>
  </form>

  <div id="result" class="panel" aria-live="polite" style="display:none;"></div>
  <div id="details" class="panel" style="display:none;"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const resultDiv = document.getElementById('result');
    const detailsDiv = document.getElementById('details');
    const fileNameEl = document.getElementById('fileName');
    const clearBtn = document.getElementById('clearBtn');

    let currentFile = null;

    function bytesToHuman(n) {
      if (!Number.isFinite(n)) return '';
      const units = ['B','KB','MB','GB','TB'];
      let i = 0; let v = n;
      while (v >= 1024 && i < units.length-1) { v /= 1024; i++; }
      return `${v.toFixed(v >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
    }

    function setFile(file) {
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      currentFile = file;
      fileNameEl.textContent = `Selected: ${file.name} (${bytesToHuman(file.size)})`;
    }

    function renderHeader(result) {
      let text, cls;
      if (result.safe) {
        text = `âœ“ ${result.message || 'File is clean'}`;
        cls = 'ok';
      } else {
        const items = (result.threats && result.threats.length)
          ? result.threats.join(', ')
          : 'Unknown';
        text = `âœ— ${result.message || 'Threats detected'} â€” ${items}`;
        cls = 'bad';
      }
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `<div class="${cls}">${text}</div>`;
    }

    function renderDetailsForm(result) {
      detailsDiv.style.display = 'block';
      const when = new Date().toLocaleString();
      const verdict = result.safe ? 'Clean' : 'Threats detected';
      const verdictClass = result.safe ? 'ok' : 'bad';

      // Build engines section
      const engines = Array.isArray(result.scan_results) ? result.scan_results : [];
      const enginesHTML = engines.map(r => {
        const eng = r.engine || 'Engine';
        const status = r.status || 'unknown';

          // details can be a string or array (YARA threats array)
        let detail = '';
        if (r.details) {
          if (typeof r.details === 'string') {
            detail = r.details;
          } else if (Array.isArray(r.details)) {
            // YARA details array of matches: show rule names
            const rules = r.details.map(d => d.rule || JSON.stringify(d)).join('; ');
            detail = rules;
          } else if (typeof r.details === 'object') {
            detail = JSON.stringify(r.details);
          }
        } else if (r.error) {
          detail = `error: ${r.error}`;
        }

        // Render any YARA tags/meta as chips
        let chips = '';
        if (Array.isArray(r.details)) {
          const allTags = r.details.flatMap(d => d.tags || []);
          if (allTags.length) {
            chips = `<div class="muted">Tags: ${[...new Set(allTags)].map(t=>`<span class="tag">${t}</span>`).join('')}</div>`;
          }
        }

        return `
          <div class="engine">
            <div class="field"><label>Engine</label><div>${eng}</div></div>
            <div class="field"><label>Status</label><div>${status}</div></div>
            ${detail ? `<div class="field"><label>Details</label><div>${detail}</div></div>` : ''}
            ${chips}
          </div>
        `;
      }).join('');

      // Threat list
      const threatList = (result.threats && result.threats.length)
        ? `<ul>${result.threats.map(t=>`<li>${t}</li>`).join('')}</ul>`
        : `<div class="muted">No threats listed.</div>`;

      // File meta
      const fname = currentFile ? currentFile.name : '(unknown)';
      const fsize = currentFile ? bytesToHuman(currentFile.size) : '';
      const ftype = currentFile ? (currentFile.type || 'â€”') : 'â€”';

      // Build the final HTML (Hash + download removed)
      detailsDiv.innerHTML = `
        <form id="detailsForm" class="kv">
          <label>Filename</label><input type="text" value="${fname}" readonly />
          <label>Size</label><input type="text" value="${fsize}" readonly />
          <label>Type</label><input type="text" value="${ftype}" readonly />
          <label>Scanned</label><input type="text" value="${when}" readonly />
          <label>Verdict</label><input class="${verdictClass}" type="text" value="${verdict}" readonly />
          <div style="grid-column:1/-1; margin-top:8px;">
            <h3 style="margin:10px 0 4px;">Per-engine results</h3>
            ${enginesHTML || '<div class="muted">No engine data.</div>'}
          </div>
          <div style="grid-column:1/-1; margin-top:8px;">
            <h3 style="margin:10px 0 4px;">Threats</h3>
            <div class="threats">${threatList}</div>
          </div>
        </form>
      `;
    }

    async function uploadCurrentFile() {
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a file');
        return;
      }
      currentFile = file;
      const formData = new FormData();
      formData.append('file', file);

      // Loading state
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'Scanning file...';
      detailsDiv.style.display = 'none';
      detailsDiv.innerHTML = '';

      try {
        const response = await fetch('http://127.0.0.1:5000/upload', {
          method: 'POST',
          body: formData
        });

        const ct = response.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await response.text();
          throw new Error('Server returned non-JSON: ' + text.slice(0, 200));
        }

        const result = await response.json();
        if (!response.ok) {
          renderHeader(result);
          renderDetailsForm(result);
          return;
        }

        renderHeader(result);
        renderDetailsForm(result);
      } catch (err) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<span class="bad">Upload failed:</span> ${err.message}`;
        detailsDiv.style.display = 'none';
        detailsDiv.innerHTML = '';
      }
    }

    // Click to open file picker
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // Show chosen file name when using picker
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      fileNameEl.textContent = f ? `Selected: ${f.name} (${bytesToHuman(f.size)})` : '';
      currentFile = f || null;
    });

    // Drag & drop events
    ['dragenter','dragover'].forEach(evtName => {
      dropzone.addEventListener(evtName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave','drop'].forEach(evtName => {
      dropzone.addEventListener(evtName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (!files || !files.length) return;

      setFile(files[0]);
    });

    // Submit handler (works for both picker and drop)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await uploadCurrentFile();
    });

    clearBtn.addEventListener('click', () => {
      fileInput.value = '';
      currentFile = null;
      fileNameEl.textContent = '';
      resultDiv.style.display = 'none';
      resultDiv.textContent = '';
      detailsDiv.style.display = 'none';
      detailsDiv.innerHTML = '';
    });
  </script>

</body>
</html>


